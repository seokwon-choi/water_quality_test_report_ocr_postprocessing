# 수질검사 성적서 OCR 후처리
![image](https://user-images.githubusercontent.com/85105917/132113487-867e3f22-1c60-454b-b070-a137d9fe2e03.png)
### 1. 담당 업무
1. Hamming거리를 이용한 오타 수정 알고리즘 작성
2. 적합/부적합 판정 부분 파싱 및 판정에 따른 팝업 아이콘 색 변경
3. 지하수 오염원 데이터 수집 및 지하수 유동 데이터 수집
4. 부적합 지역 반경 설정 후 해당 반경 안에 있는 지하수 오염원 반경과 함께 표시
### 2. 개발 기획(WBS를 작성해 프로젝트 일정을 계획)
![ocr_WBS](https://user-images.githubusercontent.com/85105917/132103555-3cac65ef-82a8-4f8e-b632-242d037b3ba6.png)
#### 2-1. 기획 배경
1. 기존의 수질 관리 방식은 수질을 측정하고 각 기관마다 수질 성적표에 수기로 작성
2. 통계청에서 전산화시 직접 타이핑을 통해 전산화시키다 보니 업무 효율이 떨어짐
#### 2-2. 서비스 구성도 설계 
![image](https://user-images.githubusercontent.com/85105917/132104110-dfb8f95f-d8e8-4bab-beae-12ae775cc80e.png)
1. 수질검사성적서를 OCR을 통해 한번에 전산화함
2. 채수장소 주변에 지하수를 오염시킬 가능성이 있는 오염 가능 시설의 위치를 보여줌
3. 이를 통해 편리하게 수질 성적표를 전산화할 수 있으며, 지하수 오염원인 분석을 도움
### 3. 프로젝트 진행 과정
● 수질검사성적서 이미지를 Google Cloud Vision API의 OCR 기능을 통해 인식해 텍스트 파일로 변환한다. 이미지 속 모든 문자를 인식한 텍스트 파일에서 필요한 정보만을 추출해내는 파싱 단계와 오인식된 단어들을 수정하는 후처리 단계를 거친 후, 이를 지도에 띄워 시각화 한다.
![image](https://user-images.githubusercontent.com/85105917/132104165-5f72f237-089a-465a-a067-002003311757.png)

#### 3-1. 파싱
1. OCR 결과 텍스트 파일은 이미지에 있는 모든 글자를 담고 있어 필요없는 데이터까지 존재해 정제과정이 필수적이다.
2. 지하수 검사를 진행한 업체명, 채수장소의 주소, 채수일자, 최종 판정 결과, 그리고 검사항목 화학물의 이름과 각각의 기준, 검사 결과를 추출한다.
![image](https://user-images.githubusercontent.com/85105917/132104393-338298ad-9a42-464e-9c24-1637b4a3bf58.png)
3. 채수일자
    - 검사성적서 샘플들을 확인한 결과 채수일자 외에 시행일자, 접수일자, 발급일자와 같은 날짜들이 기재되어 있는데 그 중 채수일자가 가장 빠른 날짜임을 알 수 있었다.
    - 날짜 형식으로 된 문자열을 모두 찾은 후 날짜들을 비교해 가장 빠른 날짜가 채수일자로 파싱되도록 구현했다.
4. 채수장소
    - 채수장소의 항목명은 검사 업체에 따라 ‘채수장소’, ‘시료채취주소’, ‘지하수개발·이용시설위치’ 등 다양하게 표현되었다
    - 검사성적서 샘플들에서 채수장소 항목명의 표현을 모두 수집한 후 검색 대상에 이를 추가하고, 해당 줄 또는 다음 줄에 있는 주소를 파싱하도록 구현했다.
6. 판정 결과
    - 판정 결과는 적합 또는 부적합으로 나타난다. 따라서 이 두 단어를 찾는 것으로 판정 결과를 파싱했다.
8. 검사항목
    - 검사항목의 범위를 지정해 예외되는 텍스트를 제외한 모든 텍스트에 대해 SymSpell을 수행해 수정했다.
    
        ■ 예외 텍스트
        
            - 파싱 대상에서 제외한 경우
            
                □ 알파벳이 포함된 문자열
                
                □ 다른 항목명에 해당되는 문자열
                
                □ SymSpell 결과 유사단어 후보가 나오지 않거나 5개보다 많은 문자열 (검사항목 단어로 특정되지 않음)
                
            - 파싱 대상에 포함되나 후처리 대상에서 제외한 경우
            
                □ 화학물 리스트에 존재하는 단어 + ‘불검출’, ‘검출’, ‘없음’
                
                □ 숫자로만 구성된 문자열
                
                □ 단위를 포함한 문자열
                
    - 수정된 텍스트를 이용해 숫자로만 된 경우나 ‘불검출, 검출, 없음’의 단어는 검사결과로, 단위가 붙어있는 경우는 검사기준으로, 나머지는 화학물로 저장한다.
    - 검사기준의 경우 환경부 지하수의수질보전등에관한규칙 제11조에 의거해 저장한 기준 파일을 읽어와 화학물에 해당하는 기준을 출력한다.

####  3-2 단어 수정
○ 정확도 : 84.48%

○ 오인식 단어 290개 중 245개의 후처리를 성공함

1. 수질성적서에서 파싱 대상들의 기존 단어들을 수집하고, OCR 과정에서 오인식된 텍스트의 경우 오타교정 알고리즘인 SymSpell을 통해 기존의 단어로 수정하도록 구현했고 SymSpell 결과의 후보 단어가 여러개인 경우 Hamming 거리를 사용하여 구현한 알고리즘을 통해 단어를 수정한다.
2. 기존 단어 데이터
    - 채수장소 주소 : 전국 도로명주소, 지번주소 데이터를 받아 주소 형식에 맞게 나누어 저장

       ![image](https://user-images.githubusercontent.com/85105917/132104796-35b726ca-687a-4513-8540-448d0853fe3e.png)

    - 최종 판정 결과 : 적합 / 부적합 두 단어 중 하나로 나타남
    - 검사항목 화학물 및 기준 : 환경부 지하수의수질보전등에관한규칙 제11조에 따라 저장
        
          - 샘플 이미지들을 확인해 하나의 화학물을 지칭하는 다른 표현까지 저장
    - 검사항목 결과 : 검출되는 경우 숫자, 아닌 경우  ‘불검출’ 또는 ‘없음’ 이라고 나타남

3. SymSpell
    - 오인식된 단어 속 글자를 삭제한 edit word를 만드는 delete(삭제) 연산을 이용해 기존 단어 데이터들과 비교해 가장 비슷한 단어로 수정한다.

4. Hamming 거리
    - SymSpell은 글자를 기준으로 유사한 단어 후보를 출력하는데, 한글의 한 글자는 자모음의 조합으로 이루어져 있어 글자의 차이가 동일하더라도 형태적으로 더 가까운 단어가 존재할 수 있다.
    - 이러한 한글의 특징을 고려하여 자모음 차이를 계산한 Hamming 거리를 이용해 가장 비슷한 단어를 출력하도록 했다.

        ![image](https://user-images.githubusercontent.com/85105917/132104789-05115614-ee9b-43e9-a8f3-24bdb1e1b06c.png)


    - 오인식단어 ‘븡소’ 에 대해 SymSpell과 해밍거리 계산을 거친 결과, 가장 가까운 단어는 ‘붕소’ 임을 확인함
    - 해밍거리 계산 값이 작을수록 가장 유사함

#### 3-3. 시각화
1. 파이썬 라이브러리 folium을 통해 지도로 시각화한다.
2. Folium의 경우 좌표를 기반으로 실행되므로 Google Maps API의 Geocoding을 이용해 파싱 및 후처리를 거친 채수장소 주소들의 좌표값을 구한다. 
3. 채수장소는 판정 결과에 따라 다른 색의 마커로 표시한다. 마커를 클릭하면 수질검사성적표가 표시된다.

![image](https://user-images.githubusercontent.com/85105917/132105460-a164f0df-5d5c-4188-988a-bdcd23165356.png)


4. 지하수 오염가능시설들의 주소 데이터를 수집해 종류에 따라 다른 색의 원으로 표시한다. 오염원에 마우스를 가까이하면 팝업으로 해당 오염원의 시설 이름이 표시된다.

    - 대표적인 지하수 오염 원인
        - 생활하수
        - 공장폐수
        - 골프장
        - 폐기물 매립지
        - 주유소의 낙후된 송유관으로 인한 석유 유출
        - 도축, 축산
        
![image](https://user-images.githubusercontent.com/85105917/132105433-96f1e437-ac7b-47c2-bfec-432aab565604.png)


5. 국가지하수정보센터에서 WMS 형태로 제공하는 오픈API를 활용해 지도에 지하수유동방향 레이어를 추가한다. 

### 4. 본 프로젝트 결과물의 특징 및 차별화

![image](https://user-images.githubusercontent.com/85105917/132105777-64741e54-df80-4dbb-9d9c-3a61379eeb9a.png)

#### 4-1. 경쟁력
1. 수질검사성적서를 전산화할 때 OCR을 사용하고 한번에 여러장을 처리하여 업무 효율을 높일 수 있다.
2. 검사 결과 자동 인식으로  업무효율을 높일 수 있다.
3. 지하수를 분석할 때 채수장소가 자동으로 인식 후 지도에 표시되고 한개의 지도만으로 분석할 수 있기 때문에 분석이 빠르고 편리하다.
4. 설정 반경안의 잠재오염원만 볼 수 있고 업체명도 볼 수 있어서 분석이 편리하다. 

### 5. 데이터 및 참고자료 출처
1. 오염원 데이터
    - 기타 수질오염원 설치시설 : (https://www.data.go.kr/data/15045116/fileData.do)
    - 폐기물 업체 : (https://www.data.go.kr/data/3070167/fileData.do)
    - 골프장 : (https://www.data.go.kr/data/15045080/fileData.do)
    - 공장 : (https://www.data.go.kr/data/3041646/fileData.do)
    - 공공하수처리시설 : (https://www.data.go.kr/data/3073222/fileData.do)
    - 도축장 : (https://www.data.go.kr/data/15030239/fileData.do)
    - 지정폐기물 배출 사업장 : (https://www.data.go.kr/data/15068827/fileData.do)
    - 지하수 정화 업체 : (https://www.data.go.kr/data/15045117/fileData.do)
    - 주유소 : (https://www.data.go.kr/dataset/3076606/fileData.do)
    
2. 전국 주소 데이터 : (https://www.juso.go.kr/addrlink/addressBuildDevNew.do?menu=match)
3. 지하수 유동방향 지도 : (http://www.gims.go.kr/apiIntro.do)

### 6. 프로젝트를 진행하면서 어려웠던 점
1. 종이 문서로된 수질검사성적서의 스캔본의 상태에 따라 OCR결과의 차이가 심하여 파싱이 잘 되지 않았음
2. 단어 수정의 경우 Hamming거리의 개념만 가지고 알고리즘을 구현해야되어서 중간에 오류가 많았음
3. 코드의 수행시간이 오래 걸려 모든 반복문을 numpy로 바꾸는 최적화를 진행하는 과정에서 오류가 많이 발생함 

### 7. 느낀 점
1. 인턴으로 프로젝트를 진행하여 기업의 프로젝트 관리에 대해 배울 수 있었음
2. 오픈 소스 활용과 빅데이터 수집의 중요성을 배움
3. 수집한 빅데이터를 시각화하면 분석 시 인사이트 도출에 도움이 된다는 것을 느낌
